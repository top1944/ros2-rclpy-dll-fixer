# ROS2 rclpy DLLä¿®å¤ - å¿«é€ŸæŒ‡å—

## âœ… å¥½æ¶ˆæ¯ï¼

æ ¹æ®åˆšæ‰çš„æµ‹è¯•ï¼Œæ‚¨çš„ROS2ç¯å¢ƒå®é™…ä¸Š**å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†**ï¼

æµ‹è¯•ç»“æœæ˜¾ç¤ºï¼š
```
[INFO] [test_node]: ROS2èŠ‚ç‚¹è¿è¡Œæ­£å¸¸ï¼
```

è¿™è¯´æ˜rclpyå¯¼å…¥æˆåŠŸï¼ŒèŠ‚ç‚¹åˆ›å»ºä¹Ÿé€šè¿‡äº†ã€‚

---

## ğŸ“¦ ä¿®å¤å·¥å…·åŒ…

æ‚¨ç°åœ¨æ‹¥æœ‰ä»¥ä¸‹ä¿®å¤å·¥å…·ï¼š

### 1. `fix_rclpy_dll_simple.bat` - æ‰¹å¤„ç†è‡ªåŠ¨ä¿®å¤å·¥å…·
**æ¨èæ–°æ‰‹ä½¿ç”¨**

åŒå‡»è¿è¡Œæˆ–åœ¨å‘½ä»¤è¡Œæ‰§è¡Œï¼š
```bash
fix_rclpy_dll_simple.bat
```

### 2. `ä¸€é”®ä¿®å¤rclpy.py` - Pythonè‡ªåŠ¨ä¿®å¤å·¥å…·
**åŠŸèƒ½æ›´å…¨é¢**

```bash
python ä¸€é”®ä¿®å¤rclpy.py
```

### 3. `ROS2_rclpy_DLLä¿®å¤æ•™ç¨‹.md` - è¯¦ç»†æ•™ç¨‹æ–‡æ¡£
åŒ…å«å®Œæ•´çš„æ•…éšœæ’é™¤å’ŒæŠ€æœ¯ç»†èŠ‚

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨ROS2 PythonèŠ‚ç‚¹

### æ–¹æ³•1ï¼šåœ¨ä»£ç ä¸­è®¾ç½®DLLè·¯å¾„ï¼ˆæ¨èï¼‰

åœ¨æ¯ä¸ªROS2 Pythonè„šæœ¬å¼€å¤´æ·»åŠ ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os

# è®¾ç½®ROS2 DLLæœç´¢è·¯å¾„ï¼ˆå¿…é¡»ï¼ï¼‰
ros2_bin = os.path.expandvars(r'%ROS2_HOME%\bin')
os.add_dll_directory(ros2_bin)
os.environ['PATH'] = ros2_bin + os.pathsep + os.environ.get('PATH', '')

# ç°åœ¨å¯ä»¥æ­£å¸¸å¯¼å…¥rclpy
import rclpy
from rclpy.node import Node

class MyNode(Node):
    def __init__(self):
        super().__init__('my_node')
        self.get_logger().info('èŠ‚ç‚¹å¯åŠ¨æˆåŠŸï¼')

def main():
    rclpy.init()
    node = MyNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### æ–¹æ³•2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡æ‰¹å¤„ç†è„šæœ¬

åˆ›å»º `run_my_node.bat`:

```batch
@echo off
set "PATH=%ROS2_HOME%\bin;%PATH%"
set "PYTHONPATH=%ROS2_HOME%\Lib\site-packages;%PYTHONPATH%"
python my_node.py
pause
```

### æ–¹æ³•3ï¼šæ°¸ä¹…è®¾ç½®ç¯å¢ƒå˜é‡

1. å³é”®"æ­¤ç”µè„‘" â†’ "å±æ€§"
2. "é«˜çº§ç³»ç»Ÿè®¾ç½®" â†’ "ç¯å¢ƒå˜é‡"
3. åœ¨"ç³»ç»Ÿå˜é‡"ä¸­æ·»åŠ ï¼š

| å˜é‡å | å€¼ |
|--------|-----|
| PATH | æ·»åŠ  `%ROS2_HOME%\bin` |
| PYTHONPATH | æ·»åŠ  `%ROS2_HOME%\Lib\site-packages` |

---

## ğŸ§ª æµ‹è¯•æ‚¨çš„ROS2èŠ‚ç‚¹

è¿è¡Œå·²ç”Ÿæˆçš„æµ‹è¯•èŠ‚ç‚¹ï¼š

```bash
cd %ROS2_HOME%\bin
python test_node_simple.py
```

é¢„æœŸè¾“å‡ºï¼š
```
[INFO] [simple_node]: ROS2èŠ‚ç‚¹è¿è¡Œæ­£å¸¸ï¼
```

---

## âš ï¸ é‡è¦æç¤º

### 1. å§‹ç»ˆåœ¨å¯¼å…¥rclpyå‰è®¾ç½®DLLè·¯å¾„

è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯é¡ºåºï¼š

**é”™è¯¯ï¼š**
```python
import rclpy  # âŒ è¿˜æ²¡è®¾ç½®DLLè·¯å¾„å°±å¯¼å…¥
os.add_dll_directory(os.path.expandvars(r'%ROS2_HOME%\bin'))  # å¤ªæ™šäº†
```

**æ­£ç¡®ï¼š**
```python
import os
os.add_dll_directory(os.path.expandvars(r'%ROS2_HOME%\bin'))  # âœ… å…ˆè®¾ç½®
import rclpy  # ç„¶åå¯¼å…¥
```

### 2. Pythonç‰ˆæœ¬è¦æ±‚

ROS2 Humble **å¿…é¡»**ä½¿ç”¨ Python 3.10

æ£€æŸ¥ç‰ˆæœ¬ï¼š
```bash
python --version
```

### 3. 64ä½ç³»ç»Ÿ

ç¡®ä¿æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯64ä½ï¼š
- Windows 10/11 64ä½
- Python 64ä½
- ROS2 Humble 64ä½

---

## ğŸ“ åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªROS2èŠ‚ç‚¹

### ç®€å•çš„å‘å¸ƒè€…èŠ‚ç‚¹

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
ros2_bin = os.path.expandvars(r'%ROS2_HOME%\bin')
os.add_dll_directory(ros2_bin)
os.environ['PATH'] = ros2_bin + os.pathsep + os.environ.get('PATH', '')

import rclpy
from rclpy.node import Node
from std_msgs.msg import String

class PublisherNode(Node):
    def __init__(self):
        super().__init__('publisher_node')
        self.publisher_ = self.create_publisher(String, 'topic', 10)
        self.timer = self.create_timer(1.0, self.timer_callback)
        self.get_logger().info('å‘å¸ƒè€…èŠ‚ç‚¹å·²å¯åŠ¨')

    def timer_callback(self):
        msg = String()
        msg.data = f'Hello ROS2! Count: {self.count}'
        self.publisher_.publish(msg)
        self.get_logger().info(f'å‘å¸ƒ: {msg.data}')

def main():
    rclpy.init()
    node = PublisherNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()
```

### ç®€å•çš„è®¢é˜…è€…èŠ‚ç‚¹

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
ros2_bin = os.path.expandvars(r'%ROS2_HOME%\bin')
os.add_dll_directory(ros2_bin)
os.environ['PATH'] = ros2_bin + os.pathsep + os.environ.get('PATH', '')

import rclpy
from rclpy.node import Node
from std_msgs.msg import String

class SubscriberNode(Node):
    def __init__(self):
        super().__init__('subscriber_node')
        self.subscription = self.create_subscription(
            String,
            'topic',
            self.listener_callback,
            10
        )
        self.get_logger().info('è®¢é˜…è€…èŠ‚ç‚¹å·²å¯åŠ¨')

    def listener_callback(self, msg):
        self.get_logger().info(f'æ”¶åˆ°: {msg.data}')

def main():
    rclpy.init()
    node = SubscriberNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ï¼š`ImportError: DLL load failed`

**è§£å†³ï¼š**
1. ç¡®ä¿åœ¨å¯¼å…¥rclpyå‰è®¾ç½®äº†DLLè·¯å¾„
2. æ£€æŸ¥spdlog.dllæ˜¯å¦åœ¨binç›®å½•ä¸­
3. è¿è¡Œä¿®å¤å·¥å…·ï¼š`python ä¸€é”®ä¿®å¤rclpy.py`

### é—®é¢˜ï¼šæ‰¾ä¸åˆ°Pythonæ¨¡å—

**è§£å†³ï¼š**
```bash
pip install packaging numpy netifaces pyyaml lxml
```

### é—®é¢˜ï¼š`python --version`æ˜¾ç¤ºé”™è¯¯ç‰ˆæœ¬

**è§£å†³ï¼š**
1. å®‰è£…Python 3.10ï¼šhttps://www.python.org/downloads/
2. åœ¨PATHä¸­ç¡®ä¿æ­£ç¡®çš„Pythonè·¯å¾„åœ¨æœ€å‰é¢

---

## ğŸ“š æ›´å¤šèµ„æº

- [ROS2å®˜æ–¹æ•™ç¨‹](https://docs.ros.org/en/humble/Tutorials.html)
- [ROS2 PythonèŠ‚ç‚¹æ•™ç¨‹](https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Writing-A-Simple-Py-Publisher-And-Subscriber.html)
- æœ¬åœ°æ–‡æ¡£ï¼š`ROS2_rclpy_DLLä¿®å¤æ•™ç¨‹.md`

---

## âœ¨ å¿«é€Ÿå‚è€ƒ

### ç¯å¢ƒå˜é‡è®¾ç½®ï¼ˆå•æ¬¡ï¼‰
```batch
set PATH=%ROS2_HOME%\bin;%PATH%
set PYTHONPATH=%ROS2_HOME%\Lib\site-packages;%PYTHONPATH%
```

### Pythonä»£ç æ¨¡æ¿
```python
import os
ros2_bin = os.path.expandvars(r'%ROS2_HOME%\bin')
os.add_dll_directory(ros2_bin)
os.environ['PATH'] = ros2_bin + os.pathsep + os.environ.get('PATH', '')

import rclpy
from rclpy.node import Node
# ... æ‚¨çš„ROS2ä»£ç 
```

### è¿è¡ŒèŠ‚ç‚¹
```bash
python my_node.py
```

---

**æ›´æ–°æ—¥æœŸï¼š** 2026-02-23
**é€‚ç”¨ç‰ˆæœ¬ï¼š** ROS2 Humble + Python 3.10 + Windows 10/11

**ç¥æ‚¨å¼€å‘é¡ºåˆ©ï¼** ğŸš€
